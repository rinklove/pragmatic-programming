# ìˆœí™˜ ì°¸ì¡°(Circular Reference)

ë‘ ê°œ ì´ìƒì˜ ê°ì²´ë‚˜ ì»´í¬ë„ŒíŠ¸ê°€ **ì‚¬ì´í´**ì„ í˜•ì„±í•˜ë©° **ì°¸ì¡°**í•˜ëŠ” ê²ƒ.

**ìˆœí™˜ ì°¸ì¡°ê°€ ë§ì´ ë°œìƒí•˜ëŠ” ì˜ˆì‹œ**

1. **JPA Entity ë§¤í•‘**
2. **Service Componentê°„ì˜ ì°¸ì¡°**

## ìˆœí™˜ ì°¸ì¡°ì˜ ë¬¸ì œ

- ë¬´í•œ ë£¨í”„ â†’ StackOverFlowError

Obeservatoryì™€ AlertInfoëŠ” ì„œë¡œ ìˆœí™˜ ì°¸ì¡° ê´€ê³„ì„.
í˜„ì¬ ì´ ë‘ EntityëŠ” fetchTypeì´ LAZYì´ê¸° ë•Œë¬¸ì—, Referenced Entityë¥¼ ë¶ˆëŸ¬ì˜¤ê¸° ì „ê¹Œì§€ëŠ” ìˆœí™˜ì°¸ì¡°ê°€ ë°œìƒí•˜ì§€ ì•ŠìŒ.

```java
Entity
@Table(name = "OBSERVATORY")
@Builder
@EqualsAndHashCode
@BatchSize(size = 25)
@Getter @ToString(of = {"no", "obsCode", "region"})
@NoArgsConstructor
@AllArgsConstructor
public class Observatory {

    @Id @GeneratedValue(strategy = GenerationType.SEQUENCE, generator = "observatory_seq")
    @SequenceGenerator(name = "observatory_seq", sequenceName = "OBSERVATORY_SEQ", allocationSize = 1)
    private Long no;

    @Column(name = "OBS_CODE")
    private String obsCode;         //ê´€ì¸¡ì½”ë“œ

    @Column(name = "REGION")
    private String region;          //ì§€ì—­

    @OneToMany(mappedBy = "observatory")
    private List<DustInfo> dustInfos = new ArrayList<>();   //ë¯¸ì„¸ë¨¼ì§€ ê´€ì¸¡ ë°ì´í„° í…Œì´ë¸”ê³¼ ì—°ê´€ê´€ê³„ ë§¤í•‘ì„ ìœ„í•œ ë³€ìˆ˜

    **@OneToMany(mappedBy = "observatory")
    private List<AlertInfo> alertInfos = new ArrayList<>(); //ë¯¸ì„¸ë¨¼ì§€ ì•ŒëŒ ë°ì´í„° í…Œì´ë¸”ê³¼ ì—°ê´€ê´€ê³„ ë§¤í•‘ì„ ìœ„í•œ ë³€ìˆ˜**
}

@Entity
@Table(name = "ALERT_INFO")
@Builder
@Getter
@ToString
@NoArgsConstructor
@AllArgsConstructor
public class AlertInfo {

    @Id @Column(name = "NO")
    @GeneratedValue(strategy = GenerationType.SEQUENCE, generator = "alert_info_seq")
    @SequenceGenerator(name = "alert_info_seq", sequenceName = "ALERT_INFO_SEQ", allocationSize = 1)
    private Long no;

    **@ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "OBSERVATORY_NO")
    private Observatory observatory;**

    @Column(name = "GRADE")
    @Check(constraints = "GRADE IN (1,2,3,4)")
    private Integer grade;      //ë“±ê¸‰

    @Column(name = "ALERT_DATE")
    private LocalDateTime alertDate;    //ì•ŒëŒ ë°œìƒ ì‹œê°„
}
```

í•˜ì§€ë§Œ, ì´ ì—”í‹°í‹°ë¥¼ Json ê°ì²´ë¡œ ì§ë ¬í™”í•˜ëŠ” ì‹œì ì— ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŒ.

<aside>
ğŸ’¡

**ë‚˜ì˜ ìƒê°**

ì˜ì†í™”ëœ ì—”í‹°í‹°ë¥¼ ë°˜í™˜í•˜ëŠ” ê²½ìš° â‡’ í”„ë¡ íŠ¸ì—ì„  JSONìœ¼ë¡œ ë°›ìŒ.<br/>
â†’ ë°˜í™˜ë˜ëŠ” ê°ì²´ë¥¼ ë°˜í™˜í•˜ëŠ” ê³¼ì •ì—ì„œ getterë¥¼ í˜¸ì¶œ <br/>
â†’ getterë¥¼ í˜¸ì¶œí•˜ëŠ” ì‹œì ì— ì°¸ì¡°ëœ ì—”í‹°í‹°ë¥¼ ê°€ì ¸ì˜´. <br/>
â†’ ì°¸ì¡°ëœ ì—”í‹°í‹°ì—ì„œë„ getterë¥¼ í˜¸ì¶œí•¨. <br/>
â†’ ì´ ê³¼ì •ì´ ë°˜ë³µë˜ì–´ StackOverFlowê°€ ë°œìƒ.

</aside>

- ì‹œìŠ¤í…œ ë³µì¡ë„ ì¦ê°€.

## ìˆœí™˜ ì°¸ì¡°ë¥¼ í•´ê²°í•˜ëŠ” ë°©ë²•

1. ë¶ˆí•„ìš”í•œ ì°¸ì¡° ì œê±°
    1. ì–‘ë°©í–¥ìœ¼ë¡œ ë§¤í•‘ëœ ë‘ ì—”í‹°í‹° ì¤‘ í•˜ë‚˜ì˜ ê´€ê³„ë¥¼ ì œê±°
    2. ê°„ì ‘ ì°¸ì¡° í™œìš©
       â†’ ì—”í‹°í‹° ëŒ€ì‹ , ì°¸ì¡°í•˜ë ¤ëŠ” ì—”í‹°í‹°ì˜ pkë¥¼ ì¼ë°˜ ì¹¼ëŸ¼ìœ¼ë¡œ ë³€ê²½.

## ëª°ëë˜ ê°œë… ì •ë¦¬

### @JsonIdentityInfo

```java
package com.fasterxml.jackson.annotation;

import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

@Target({ElementType.ANNOTATION_TYPE, ElementType.TYPE, ElementType.FIELD, ElementType.METHOD, ElementType.PARAMETER})
@Retention(RetentionPolicy.RUNTIME)
@JacksonAnnotation
public @interface JsonIdentityInfo {
		//ê°ì²´ì˜ idë¥¼ jsonì—ì„œ ì–´ë–¤ keyìœ¼ë¡œ ë³´ì—¬ì¤„ì§€ì— ëŒ€í•œ ì†ì„±.
		//ì´ë¯¸ ì§ë ¬í™”ê°€ ëœ ê°ì²´ëŠ” ë‹¤ì‹œ ì§ë ¬í™” ë˜ì§€ ì•ŠëŠ”ë‹¤.
		//jsonì—ì„œ idì˜ í‚¤ ê°’ì€ ê¸°ë³¸ì ìœ¼ë¡œ "@id"ë¡œ í‘œí˜„ëœë‹¤.
		//ê°ì²´ì—ì„œëŠ” @idê°€ ìˆëŠ” í•„ë“œê°€ jsonì—ì„œì˜ idë¡œ í‘œí˜„
    String property() default "@id";    

		//ê°ì²´ì— ëŒ€í•œ ì‹ë³„ìë¥¼ ìƒì„±í•˜ëŠ” ë° ì‚¬ìš©í•˜ëŠ” ìƒì„±ê¸°,
		//propertyì— ì§€ì •ëœ ì†ì„±ì„ ë°”íƒ•ìœ¼ë¡œ ì‹ë³„.
		//ObjectIdGenerator ë˜ëŠ” ì´ë¥¼ ìƒì†í•˜ì—¬ ì»¤ìŠ¤í…€í•œ Generator ì‚¬ìš© ê°€ëŠ¥
    Class<? extends ObjectIdGenerator<?>> generator();

    //ì§ë ¬í™”ëœ ê°ì²´ì˜ idë¥¼ ê´€ë¦¬í•˜ëŠ” Resolverë¥¼ ì„¤ì •í•˜ëŠ” ì†ì„±
    //ê¸°ë³¸ì ìœ¼ë¡œ propertyì— ì§€ì •ëœ ì‹ë³„ìë¥¼ ê´€ë¦¬í•˜ë©° 
    //idê°’ì„ ê¸°ì¤€ìœ¼ë¡œ í•œë²ˆë§Œ ì§ë ¬í™” ì‹œì¼œì£¼ëŠ” SimpleObjectIdResolverê°€ ê¸°ë³¸ê°’ìœ¼ë¡œ ì ìš©
    Class<? extends ObjectIdResolver> resolver() default SimpleObjectIdResolver.class;

		//ì´ ì–´ë…¸í…Œì´ì…˜ì´ ì ìš©ë˜ëŠ” í´ë˜ìŠ¤. 
		//ì´ ì†ì„±ì„ ëª…ì‹œí•˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ì ìœ¼ë¡œ Object í´ë˜ìŠ¤ì— ì ìš©ëœë‹¤.
    Class<?> scope() default Object.class;
}

```